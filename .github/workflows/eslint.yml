name: ESLint

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '15 19 * * 4'

jobs:
  eslint:
    name: Run eslint scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check ESLint configuration
        id: check-config
        run: |
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f ".eslintrc.cjs" ] || [ -f "eslint.config.js" ] || [ -f "eslint.config.mjs" ]; then
            echo "ESLint config found"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "No ESLint config found - creating minimal config"
            echo '{"parser":"@typescript-eslint/parser","plugins":["@typescript-eslint"],"extends":["eslint:recommended","plugin:@typescript-eslint/recommended"],"parserOptions":{"ecmaVersion":2020,"sourceType":"module"}}' > .eslintrc.json
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Install ESLint tools
        run: |
          if ! npx eslint --version 2>/dev/null; then
            npm install eslint@8.57.0 @typescript-eslint/parser@6 @typescript-eslint/eslint-plugin@6 --save-dev
          fi
          npm install @microsoft/eslint-formatter-sarif@3.1.0 --save-dev

      - name: Verify files
        run: |
          echo "=== TS/TSX files (excluding node_modules) ==="
          find . -type f \( -name "*.ts" -o -name "*.tsx" \) ! -path "./node_modules/*" ! -path "./.git/*" | head -20
          
          echo "=== ESLint config ==="
          cat .eslintrc.js 2>/dev/null || cat .eslintrc.json 2>/dev/null || cat eslint.config.js 2>/dev/null || echo "Using default"

      - name: Run ESLint
        env:
          SARIF_ESLINT_IGNORE_SUPPRESSED: "true"
        run: |
          npx eslint . \
            --ext .ts,.tsx \
            --format @microsoft/eslint-formatter-sarif \
            --output-file eslint-results.sarif \
            2>&1 | tee eslint-output.log || true
        continue-on-error: true

      - name: Validate SARIF
        run: |
          echo "=== ESLint output ==="
          cat eslint-output.log || echo "No log file"
          
          echo "=== SARIF file info ==="
          ls -la eslint-results.sarif 2>/dev/null || echo "SARIF file not created"
          
          # 检查 runs 数组是否为空
          if [ -f "eslint-results.sarif" ]; then
            RUNS_COUNT=$(grep -o '"runs":\[[^]]*\]' eslint-results.sarif | grep -o '{' | wc -l || echo "0")
            echo "Runs count: $RUNS_COUNT"
            
            # 如果 runs 为空或文件无效，创建最小有效 SARIF
            if [ "$RUNS_COUNT" -lt 1 ]; then
              echo "Creating minimal valid SARIF file"
              cat > eslint-results.sarif << 'EOF'
{
  "version": "2.1.0",
  "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
  "runs": [{
    "tool": {
      "driver": {
        "name": "ESLint",
        "informationUri": "https://eslint.org",
        "rules": []
      }
    },
    "results": []
  }]
}
EOF
            fi
          else
            echo "Creating SARIF file from scratch"
            cat > eslint-results.sarif << 'EOF'
{
  "version": "2.1.0",
  "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
  "runs": [{
    "tool": {
      "driver": {
        "name": "ESLint",
        "informationUri": "https://eslint.org",
        "rules": []
      }
    },
    "results": []
  }]
}
EOF
          fi
          
          echo "=== Final SARIF content ==="
          head -20 eslint-results.sarif
      - name: Upload analysis results to GitHub
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: eslint-results.sarif
          wait-for-processing: true

      - name: Cleanup temporary config
        if: steps.check-config.outputs.exists == 'false'
        run: rm -f .eslintrc.json
