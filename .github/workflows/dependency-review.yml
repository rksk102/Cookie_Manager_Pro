name: 'Dependency review'
on:
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  dependency-review:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: 'Setup Node.js'
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '20'

      - name: 'Dependency Review'
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        with:
          comment-summary-in-pr: always

      - name: 'Install dependencies'
        run: npm ci

      - name: 'Security Audit'
        id: audit
        run: |
          echo "## ğŸ”’ Security Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          AUDIT_OUTPUT=$(npm audit --audit-level=moderate 2>&1 || true)

          if echo "$AUDIT_OUTPUT" | grep -q "found 0 vulnerabilities"; then
            echo "âœ… No known vulnerabilities found" >> $GITHUB_STEP_SUMMARY
            echo "audit_status=clean" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Vulnerabilities detected:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$AUDIT_OUTPUT" | head -50 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "audit_status=warning" >> $GITHUB_OUTPUT
          fi

      - name: 'License Check'
        id: license
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“œ License Compliance Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          LICENSES=$(npm ls --json 2>/dev/null | jq -r '.dependencies | to_entries[] | "\(.key): \(.value.version)"' 2>/dev/null || echo "Unable to parse licenses")

          FORBIDDEN_LICENSES="GPL-3.0 AGPL-3.0 SSPL"
          HAS_FORBIDDEN=false

          echo "Checking for forbidden licenses..." >> $GITHUB_STEP_SUMMARY
          echo "Forbidden licenses: $FORBIDDEN_LICENSES" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "license_status=ok" >> $GITHUB_OUTPUT
          echo "âœ… License check passed" >> $GITHUB_STEP_SUMMARY

      - name: 'Dependency Size Check'
        id: size
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“¦ Dependency Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          NODE_MODULES_SIZE=$(du -sh node_modules 2>/dev/null | cut -f1 || echo "unknown")
          DEPENDENCY_COUNT=$(npm ls --depth=0 2>/dev/null | grep -c "^[â”œâ””]" || echo "0")

          echo "- **node_modules size**: $NODE_MODULES_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- **Direct dependencies**: $DEPENDENCY_COUNT" >> $GITHUB_STEP_SUMMARY

          echo "size=$NODE_MODULES_SIZE" >> $GITHUB_OUTPUT
          echo "count=$DEPENDENCY_COUNT" >> $GITHUB_OUTPUT

      - name: 'Create PR Comment'
        if: github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const auditStatus = '${{ steps.audit.outputs.audit_status }}';
            const licenseStatus = '${{ steps.license.outputs.license_status }}';
            const depSize = '${{ steps.size.outputs.size }}';
            const depCount = '${{ steps.size.outputs.count }}';

            const statusEmoji = (status) => {
              if (status === 'clean' || status === 'ok') return 'âœ…';
              if (status === 'warning') return 'âš ï¸';
              return 'â“';
            };

            const body = `## ğŸ” Dependency Review Summary

            | Check | Status | Details |
            |-------|--------|---------|
            | Security Audit | ${statusEmoji(auditStatus)} | ${auditStatus === 'clean' ? 'No vulnerabilities' : 'Review required'} |
            | License Check | ${statusEmoji(licenseStatus)} | ${licenseStatus === 'ok' ? 'Compliant' : 'Review required'} |
            | Dependencies | ğŸ“¦ | ${depCount} direct, ${depSize} total |

            ${auditStatus === 'warning' ? 'âš ï¸ **Action Required**: Please review the security audit findings above.' : ''}
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
