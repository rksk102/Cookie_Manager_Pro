name: Build and Check Browser Extension

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  actions: read
  contents: write
  packages: write
  pull-requests: write
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-check:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: '20'

      - name: Get npm cache directory
        id: npm-cache-dir
        run: echo "dir=$(npm config get cache)" >> $GITHUB_OUTPUT

      - name: Cache npm dependencies
        uses: actions/cache@v5.0.3
        with:
          path: ${{ steps.npm-cache-dir.outputs.dir }}
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Cache Plasmo build
        uses: actions/cache@v5.0.3
        with:
          path: |
            .plasmo
            build
          key: ${{ runner.os }}-plasmo-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-plasmo-

      - name: Install dependencies
        run: npm ci

      - name: Check for secrets leakage
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          extra_args: --only-verified

      - name: Dependency audit
        run: npm audit --production || true
        continue-on-error: true

      - name: TypeScript check
        run: npx tsc --noEmit

      - name: Lint check
        run: |
          if [ -f "package.json" ] && grep -q "eslint" package.json; then
            npm run lint
          else
            echo "â„¹ï¸ ESLint not configured, skipping lint check"
          fi

      - name: Format check
        run: |
          if [ -f "package.json" ] && grep -q "prettier" package.json; then
            npm run format:check
          else
            echo "â„¹ï¸ Prettier not configured, skipping format check"
          fi

      - name: Run unit tests
        run: |
          if [ -f "package.json" ] && grep -q "vitest" package.json; then
            npm run test:coverage
          else
            echo "â„¹ï¸ Vitest not configured, skipping unit tests"
          fi

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v7.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Upload coverage reports
        if: always()
        uses: codecov/codecov-action@v5.5.2
        with:
          files: ./coverage/lcov.info
          flags: unittests
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Build extension
        run: npm run build

      - name: Verify build success
        run: |
          if [ ! -d "build" ]; then
            echo "âœ— Build directory not found"
            exit 1
          fi
          if [ ! -d "build/chrome-mv3-prod" ]; then
            echo "âœ— Production build directory not found"
            exit 1
          fi

      - name: Get project version
        id: get_version
        run: |
          VERSION=$(jq -r '.version' package.json)
          PROJECT_NAME=$(jq -r '.name' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT
          echo "build_dir=${PROJECT_NAME}-${VERSION}" >> $GITHUB_OUTPUT
          echo "zip_file=${PROJECT_NAME}-${VERSION}.zip" >> $GITHUB_OUTPUT

      - name: Package extension
        run: npm run package

      - name: Rename build artifacts
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          PROJECT_NAME=${{ steps.get_version.outputs.project_name }}
          BUILD_DIR=${{ steps.get_version.outputs.build_dir }}
          ZIP_FILE=${{ steps.get_version.outputs.zip_file }}
          
          if [ -d "build/chrome-mv3-prod" ]; then
            mv build/chrome-mv3-prod build/$BUILD_DIR
            echo "âœ“ Renamed build directory to build/$BUILD_DIR"
          fi
          
          if [ -f "build/chrome-mv3-prod.zip" ]; then
            mv build/chrome-mv3-prod.zip build/$ZIP_FILE
            echo "âœ“ Renamed zip file to build/$ZIP_FILE"
          fi

      - name: Verify zip file creation
        run: |
          ZIP_FILE=$(find build -name "*.zip" | head -1)
          if [ -f "$ZIP_FILE" ]; then
            echo "âœ“ Zip file created: $ZIP_FILE"
            ls -la "$ZIP_FILE"
            ZIP_SIZE=$(stat -c "%s" "$ZIP_FILE")
            echo "âœ“ Zip file size: $ZIP_SIZE bytes"
            if [ "$ZIP_SIZE" -lt 1000 ]; then
              echo "âš ï¸ Zip file is very small, may be incomplete"
            fi
          else
            echo "âœ— Zip file not found"
            exit 1
          fi

      - name: Verify build artifacts
        run: |
          echo "ğŸ“ Build artifacts:"
          ls -la build/
          BUILD_DIR=$(find build -type d -name "*-*" | head -1)
          if [ -d "$BUILD_DIR" ]; then
            echo "ğŸ“ Production build:"
            ls -la "$BUILD_DIR"
            REQUIRED_FILES=("manifest.json" "popup.html")
            for file in "${REQUIRED_FILES[@]}"; do
              if [ -f "$BUILD_DIR/$file" ]; then
                echo "âœ“ $file exists"
              else
                echo "âœ— $file missing"
                exit 1
              fi
            done
            if [ -f "$BUILD_DIR/static/background/index.js" ]; then
              echo "âœ“ background script exists at static/background/index.js"
            else
              echo "â„¹ï¸ background script not found"
            fi
          else
            echo "âœ— Build directory not found"
            exit 1
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6.0.0
        with:
          name: extension-build-${{ steps.get_version.outputs.version }}
          path: |
            build/
          retention-days: 7

      - name: Install Playwright browsers
        run: |
          if [ -f "package.json" ] && grep -q "@playwright/test" package.json; then
            npx playwright install --with-deps
          else
            echo "â„¹ï¸ Playwright not configured, skipping E2E tests"
          fi

      - name: Run E2E tests
        run: |
          if [ -f "package.json" ] && grep -q "@playwright/test" package.json; then
            npm run test:e2e
          else
            echo "â„¹ï¸ Playwright not configured, skipping E2E tests"
          fi

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v6.0.0
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Check manifest validity
        run: |
          if [ -f "package.json" ]; then
            echo "âœ“ Checking manifest configuration in package.json"
            cat package.json | grep -A 20 "manifest"
          else
            echo "âœ— package.json not found"
            exit 1
          fi

      - name: Check manifest.json
        run: |
          BUILD_DIR=$(find build -type d -name "*-*" | head -1)
          if [ -f "$BUILD_DIR/manifest.json" ]; then
            echo "âœ“ manifest.json exists"
            cat $BUILD_DIR/manifest.json
            if command -v jq &> /dev/null; then
              jq '.' $BUILD_DIR/manifest.json
              echo "âœ“ manifest.json is valid JSON"
            else
              echo "â„¹ï¸ jq not available, skipping JSON validation"
            fi
          else
            echo "âœ— manifest.json not found"
            exit 1
          fi

      - name: Security check
        run: |
          echo "ğŸ”’ Running security checks..."
          if grep -r "eval(" --include="*.ts" --include="*.tsx" --include="*.js" .; then
            echo "âš ï¸  Found eval() usage, potential security risk"
          else
            echo "âœ“ No eval() usage found"
          fi
          if grep -r "innerHTML" --include="*.ts" --include="*.tsx" --include="*.js" .; then
            echo "âš ï¸  Found innerHTML usage, potential XSS risk"
          else
            echo "âœ“ No innerHTML usage found"
          fi

      - name: Generate Release Notes
        if: github.event_name == 'workflow_dispatch'
        id: generate_notes
        run: |
          echo "ğŸ“‹ Available tags:"
          git tag -l | sort -V
          
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "ğŸ·ï¸ Previous tag: $PREVIOUS_TAG"
          
          CURRENT_VERSION="${{ steps.get_version.outputs.version }}"
          echo "ğŸ“Œ Current version: v$CURRENT_VERSION"
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "â„¹ï¸ No previous tag found, generating full changelog"
            NOTES=$(npx git-cliff --strip header)
          else
            echo "â„¹ï¸ Generating changelog from $PREVIOUS_TAG to HEAD"
            NOTES=$(npx git-cliff "$PREVIOUS_TAG..HEAD" --strip header)
          fi
          
          echo "ğŸ“ Generated notes:"
          echo "$NOTES"
          
          if [ -z "$NOTES" ] || [ "$NOTES" = "## [Unreleased]" ]; then
            echo "âš ï¸ No notes generated, using default"
            NOTES=$(printf "## What's Changed\n\n- ç‰ˆæœ¬æ›´æ–°è‡³ %s\n- è¯¦è§æäº¤å†å²" "$CURRENT_VERSION")
          fi
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "âœ“ Release notes generated"

      - name: Create Release
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2.5.0
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: Release v${{ steps.get_version.outputs.version }}
          body: ${{ steps.generate_notes.outputs.notes }}
          files: |
            build/*.zip
          draft: false
          prerelease: false

      - name: Summary
        run: |
          echo "## Build Summary"
          echo "âœ… All checks passed"
          echo "âœ… Build completed successfully"
          echo "âœ… TypeScript check passed"
          echo "âœ… Dependency audit completed"
          echo "âœ… ESLint check passed"
          echo "âœ… Prettier check passed"
          echo "âœ… Secrets scan completed"
          
          if [ -f "package.json" ] && grep -q "vitest" package.json; then
            echo "âœ… Unit tests passed"
          else
            echo "â„¹ï¸ Vitest not configured, skipping unit tests"
          fi
          
          if [ -f "package.json" ] && grep -q "@playwright/test" package.json; then
            echo "âœ… E2E tests passed"
          else
            echo "â„¹ï¸ Playwright not configured, skipping E2E tests"
          fi
          
          echo "âœ… Extension packaged"
          echo "âœ… Build artifacts uploaded"
          echo "âœ… SonarCloud analysis completed"
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "âœ… Release created"
            echo "âœ… Ready for deployment"
          else
            echo "â„¹ï¸ Release step skipped (manual trigger only)"
          fi
