name: Build and Check Browser Extension

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Dependency audit
        run: npm audit --production || true
        continue-on-error: true

      - name: TypeScript check
        run: npx tsc --noEmit

      - name: Lint check
        run: |
          if [ -f "package.json" ] && grep -q "eslint" package.json; then
            npm run lint
          else
            echo "‚ÑπÔ∏è ESLint not configured, skipping lint check"
          fi

      - name: Format check
        run: |
          if [ -f "package.json" ] && grep -q "prettier" package.json; then
            npm run format:check
          else
            echo "‚ÑπÔ∏è Prettier not configured, skipping format check"
          fi

      - name: Check manifest validity
        run: |
          if [ -f "package.json" ]; then
            echo "‚úì Checking manifest configuration in package.json"
            cat package.json | grep -A 20 "manifest"
          else
            echo "‚úó package.json not found"
            exit 1
          fi

      - name: Build extension
        run: npm run build

      - name: Verify build success
        run: |
          if [ ! -d "build" ]; then
            echo "‚úó Build directory not found"
            exit 1
          fi
          if [ ! -d "build/chrome-mv3-prod" ]; then
            echo "‚úó Production build directory not found"
            exit 1
          fi

      - name: Check manifest.json
        run: |
          if [ -f "build/chrome-mv3-prod/manifest.json" ]; then
            echo "‚úì manifest.json exists"
            cat build/chrome-mv3-prod/manifest.json
            # Validate manifest.json format
            if command -v jq &> /dev/null; then
              jq '.' build/chrome-mv3-prod/manifest.json
              echo "‚úì manifest.json is valid JSON"
            else
              echo "‚ÑπÔ∏è jq not available, skipping JSON validation"
            fi
          else
            echo "‚úó manifest.json not found"
            exit 1
          fi

      - name: Package extension
        run: npm run package

      - name: Verify zip file creation
        run: |
          ZIP_FILE=$(find . -name "*.zip" | head -1)
          if [ -f "$ZIP_FILE" ]; then
            echo "‚úì Zip file created: $ZIP_FILE"
            ls -la "$ZIP_FILE"
            # Check zip file size
            ZIP_SIZE=$(stat -c "%s" "$ZIP_FILE")
            echo "‚úì Zip file size: $ZIP_SIZE bytes"
            if [ "$ZIP_SIZE" -lt 1000 ]; then
              echo "‚ö†Ô∏è Zip file is very small, may be incomplete"
            fi
          else
            echo "‚úó Zip file not found"
            exit 1
          fi

      - name: Verify build artifacts
        run: |
          echo "üìÅ Build artifacts:"
          ls -la build/
          echo "üìÅ Production build:"
          ls -la build/chrome-mv3-prod/
          # Check for required files
          REQUIRED_FILES=("manifest.json" "popup.html")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "build/chrome-mv3-prod/$file" ]; then
              echo "‚úì $file exists"
            else
              echo "‚úó $file missing"
              exit 1
            fi
          done
          # Check for background script
          if [ -f "build/chrome-mv3-prod/static/background/index.js" ]; then
            echo "‚úì background script exists at static/background/index.js"
          else
            echo "‚ÑπÔ∏è background script not found"
          fi

      - name: Security check
        run: |
          echo "üîí Running security checks..."
          # Check for common security issues
          if grep -r "eval(" --include="*.ts" --include="*.tsx" --include="*.js" .; then
            echo "‚ö†Ô∏è  Found eval() usage, potential security risk"
          else
            echo "‚úì No eval() usage found"
          fi
          if grep -r "innerHTML" --include="*.ts" --include="*.tsx" --include="*.js" .; then
            echo "‚ö†Ô∏è  Found innerHTML usage, potential XSS risk"
          else
            echo "‚úì No innerHTML usage found"
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: extension-build
          path: |
            build/
            *.zip
          retention-days: 7

      - name: Summary
        run: |
          echo "## Build Summary"
          echo "‚úÖ All checks passed"
          echo "‚úÖ Build completed successfully"
          echo "‚úÖ TypeScript check passed"
          echo "‚úÖ Dependency audit completed"
          echo "‚úÖ Extension packaged"
          ZIP_FILE=$(find . -name "*.zip" | head -1)
          if [ -f "$ZIP_FILE" ]; then
            echo "‚úÖ Zip file: $(basename "$ZIP_FILE")"
          fi
          echo "‚úÖ Ready for deployment"
